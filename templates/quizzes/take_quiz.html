<!-- vscode-format: false -->
{% extends 'base.html' %}
{% load static %}
{% load quiz_tags %}

{% block title %}Taking Quiz - {{ quiz.title }}{% endblock %}

{% block extra_css %}
<style>
    .question-card {
        transition: all 0.3s ease;
    }

    .question-nav-btn {
        width: 40px;
        height: 40px;
        margin: 2px;
        border-radius: 50%;
    }

    .question-nav-btn.answered {
        background-color: #0d6efd;
        color: white;
    }

    .question-nav-btn.current {
        border: 3px solid #0d6efd;
    }

    .timer-warning {
        animation: pulse 1s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }
    }

    .option-card {
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .option-card:hover {
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .option-card.selected {
        background-color: #e7f1ff;
        border-color: #0d6efd;
        border-width: 2px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Main Quiz Area -->
        <div class="col-lg-9">
            <!-- Timer and Progress -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <h5 class="mb-0">{{ quiz.title }}</h5>
                            <small class="text-muted">{{ quiz.difficulty|title }} Level</small>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%;"
                                    aria-valuenow="0" aria-valuemin="0" aria-valuemax="{{ questions.count }}">
                                    <span id="progressText">0 / {{ questions.count }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <h3 class="mb-0" id="timerDisplay">
                                <i class="bi bi-clock"></i> <span id="timeRemaining">{{ time_remaining }}</span>
                            </h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Questions -->
            <div id="questionsContainer">
                {% for question in questions %}
                <div class="card question-card mb-3 {% if forloop.first %}active{% else %}d-none{% endif %}"
                    id="question-{{ forloop.counter }}" data-question-id="{{ question.id }}">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Question {{ forloop.counter }} of {{ questions.count }}</h5>
                    </div>
                    <div class="card-body">
                        <h4 class="mb-4">{{ question.question_text }}</h4>

                        <div class="options-container">
                            {% for option_key, option_text in question.get_options.items %}
                            <div class="card option-card mb-2 {% if user_answers|get_item:question.id == option_key %}selected{% endif %}"
                                onclick="selectOption({{ question.id }}, '{{ option_key }}', {{ forloop.parentloop.counter }})">
                                <div class="card-body d-flex align-items-center">
                                    <input type="radio" class="form-check-input me-3" name="question_{{ question.id }}"
                                        value="{{ option_key }}" id="q{{ question.id }}_{{ option_key }}" {% if user_answers|get_item:question.id == option_key %}checked{% endif %}>
                                    <label class="form-check-label flex-grow-1 mb-0"
                                        for="q{{ question.id }}_{{ option_key }}">
                                        <strong>{{ option_key }}.</strong> {{ option_text }}
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-secondary" onclick="previousQuestion()" {% if forloop.first %}disabled{% endif %} id="prevBtn-{{ forloop.counter }}">
                                <i class="bi bi-arrow-left"></i> Previous
                            </button>

                            {% if forloop.last %}
                            <button class="btn btn-success" onclick="confirmSubmit()">
                                <i class="bi bi-check-circle"></i> Submit Quiz
                            </button>
                            {% else %}
                            <button class="btn btn-primary" onclick="nextQuestion()" id="nextBtn-{{ forloop.counter }}">
                                Next <i class="bi bi-arrow-right"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Sidebar - Question Navigator -->
        <div class="col-lg-3">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="bi bi-list-check"></i> Question Navigator</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap justify-content-center" id="questionNavigator">
                        {% for question in questions %}
                        <button
                            class="btn btn-sm btn-outline-primary question-nav-btn {% if forloop.first %}current{% endif %}"
                            id="nav-btn-{{ forloop.counter }}" onclick="goToQuestion({{ forloop.counter }})"
                            title="Question {{ forloop.counter }}">
                            {{ forloop.counter }}
                        </button>
                        {% endfor %}
                    </div>
                    <hr>
                    <div class="small">
                        <div class="d-flex align-items-center mb-2">
                            <span class="question-nav-btn btn btn-sm btn-outline-primary me-2"></span>
                            <span>Unanswered</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="question-nav-btn btn btn-sm btn-outline-primary answered me-2"></span>
                            <span>Answered</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Submit Confirmation Modal -->
<div class="modal fade" id="submitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Submit Quiz?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to submit your quiz?</p>
                <p class="mb-0"><strong>Answered:</strong> <span id="answeredCount">0</span> / {{ questions.count }}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Review Answers</button>
                <form method="post" action="{% url 'quizzes:submit_quiz' attempt.id %}" id="submitForm">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success">Submit Quiz</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Quiz state
    let currentQuestion = 1;
    const totalQuestions = {{ questions.count }};
    let answeredQuestions = new Set({{ answered_question_ids| safe }});
    let timeRemaining = {{ time_remaining }};
    const attemptId = {{ attempt.id }};

    // Timer
    function startTimer() {
        const timerInterval = setInterval(function () {
            timeRemaining--;

            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const timeDisplay = document.getElementById('timeRemaining');
            timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            // Warning when less than 2 minutes
            if (timeRemaining < 120) {
                document.getElementById('timerDisplay').classList.add('timer-warning', 'text-danger');
            }

            // Auto-submit when time is up
            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                alert('Time is up! Submitting your quiz...');
                document.getElementById('submitForm').submit();
            }
        }, 1000);
    }

    // Save answer
    function selectOption(questionId, answer, questionNumber) {
        // Update UI
        const optionCards = document.querySelectorAll(`#question-${questionNumber} .option-card`);
        optionCards.forEach(card => card.classList.remove('selected'));
        event.currentTarget.classList.add('selected');

        // Check the radio button
        document.getElementById(`q${questionId}_${answer}`).checked = true;

        // Save to server
        fetch('{% url "quizzes:save_answer" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                attempt_id: attemptId,
                question_id: questionId,
                selected_answer: answer
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    answeredQuestions.add(questionId);
                    updateNavigator(questionNumber);
                    updateProgress();
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // Navigation
    function goToQuestion(questionNumber) {
        document.querySelectorAll('.question-card').forEach(card => card.classList.add('d-none'));
        document.getElementById(`question-${questionNumber}`).classList.remove('d-none');

        document.querySelectorAll('.question-nav-btn').forEach(btn => btn.classList.remove('current'));
        document.getElementById(`nav-btn-${questionNumber}`).classList.add('current');

        currentQuestion = questionNumber;
    }

    function nextQuestion() {
        if (currentQuestion < totalQuestions) {
            goToQuestion(currentQuestion + 1);
        }
    }

    function previousQuestion() {
        if (currentQuestion > 1) {
            goToQuestion(currentQuestion - 1);
        }
    }

    function updateNavigator(questionNumber) {
        document.getElementById(`nav-btn-${questionNumber}`).classList.add('answered');
    }

    function updateProgress() {
        const answered = answeredQuestions.size;
        const percentage = (answered / totalQuestions) * 100;
        document.getElementById('progressBar').style.width = percentage + '%';
        document.getElementById('progressText').textContent = `${answered} / ${totalQuestions}`;
    }

    function confirmSubmit() {
        document.getElementById('answeredCount').textContent = answeredQuestions.size;
        const modal = new bootstrap.Modal(document.getElementById('submitModal'));
        modal.show();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
        startTimer();
        updateProgress();

        // Mark already answered questions
        answeredQuestions.forEach(questionId => {
            const questionCards = document.querySelectorAll('.question-card');
            questionCards.forEach((card, index) => {
                if (parseInt(card.dataset.questionId) === questionId) {
                    updateNavigator(index + 1);
                }
            });
        });
    });

    // Warn before leaving
    window.addEventListener('beforeunload', function (e) {
        e.preventDefault();
        e.returnValue = '';
    });
</script>
{% endblock %}